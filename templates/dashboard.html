{% extends "base.html" %}

{% block title %}Dashboard - URL Monitor{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1><i class="fas fa-dashboard"></i> Monitoring Dashboard</h1>
            <div class="btn-group" role="group">
                {% for key, hours in time_filters.items() %}
                    <a href="{{ url_for('dashboard', filter=key) }}" 
                       class="btn btn-outline-primary {% if current_filter == key %}active{% endif %}">
                        {{ key.upper() }}
                    </a>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card card-stat border-primary">
            <div class="card-body text-center">
                <div class="display-6 text-primary">
                    <i class="fas fa-globe"></i>
                </div>
                <h5 class="card-title">Total URLs</h5>
                <h2 class="text-primary">{{ stats.total_urls }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card card-stat border-success">
            <div class="card-body text-center">
                <div class="display-6 text-success">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h5 class="card-title">Successful</h5>
                <h2 class="text-success">{{ stats.successful_pings }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card card-stat border-danger">
            <div class="card-body text-center">
                <div class="display-6 text-danger">
                    <i class="fas fa-times-circle"></i>
                </div>
                <h5 class="card-title">Failed</h5>
                <h2 class="text-danger">
                    {% if stats.failed_pings > 0 %}
                        <a href="{{ url_for('failed_requests', filter=current_filter) }}" class="text-decoration-none text-danger">
                            {{ stats.failed_pings }}
                        </a>
                    {% else %}
                        {{ stats.failed_pings }}
                    {% endif %}
                </h2>
                {% if stats.failed_pings > 0 %}
                    <small><a href="{{ url_for('failed_requests', filter=current_filter) }}" class="text-decoration-none">View Details</a></small>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card card-stat border-info">
            <div class="card-body text-center">
                <div class="display-6 text-info">
                    <i class="fas fa-percentage"></i>
                </div>
                <h5 class="card-title">Success Rate</h5>
                <h2 class="text-info">{{ "%.1f"|format(stats.success_rate) }}%</h2>
            </div>
        </div>
    </div>
</div>

<!-- Group Statistics Cards -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-layer-group"></i> Group Overview</h5>
                <small class="text-muted">Click on any group card to drill down into country details</small>
            </div>
            <div class="card-body">
                {% if group_stats %}
                    <div class="row">
                        {% for group in group_stats %}
                            <div class="col-lg-4 col-md-6 mb-4">
                                <div class="card h-100 group-card border-{% if group.failure_rate > 20 %}danger{% elif group.failure_rate > 5 %}warning{% else %}success{% endif %}" 
                                     style="cursor: pointer;" 
                                     onclick="window.location.href='{{ url_for('group_detail', group_name=group.group_name, filter=current_filter) }}'">
                                    <div class="card-header bg-{% if group.failure_rate > 20 %}danger{% elif group.failure_rate > 5 %}warning{% else %}success{% endif %} text-white">
                                        <h6 class="mb-0">
                                            <i class="fas fa-folder"></i> {{ group.group_name }}
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row text-center">
                                            <div class="col-6">
                                                <div class="border-end">
                                                    <h4 class="text-primary mb-0">{{ group.total_urls }}</h4>
                                                    <small class="text-muted">URLs</small>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <h4 class="text-info mb-0">{{ group.total_countries }}</h4>
                                                <small class="text-muted">Countries</small>
                                            </div>
                                        </div>
                                        
                                        <hr class="my-3">
                                        
                                        <div class="row text-center">
                                            <div class="col-6">
                                                <div class="border-end">
                                                    <h5 class="text-success mb-0">{{ group.success_rate }}%</h5>
                                                    <small class="text-muted">Success</small>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <h5 class="text-danger mb-0">{{ group.failure_rate }}%</h5>
                                                <small class="text-muted">Failure</small>
                                            </div>
                                        </div>
                                        
                                        <hr class="my-3">
                                        
                                        <div class="text-center">
                                            <h6 class="text-dark mb-0">{{ group.total_requests }}</h6>
                                            <small class="text-muted">Total Requests</small>
                                        </div>
                                        
                                        {% if group.avg_response_time > 0 %}
                                            <div class="text-center mt-2">
                                                <small class="text-muted">
                                                    <i class="fas fa-clock"></i> Avg: {{ group.avg_response_time }}ms
                                                </small>
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="card-footer bg-light text-center">
                                        <small class="text-muted">
                                            <i class="fas fa-mouse-pointer"></i> Click to drill down
                                        </small>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-info-circle fa-3x mb-3"></i>
                        <h5>No monitoring data available</h5>
                        <p>Upload a CSV file with URLs to start monitoring</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity Timeline -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-clock"></i> Recent Activity</h5>
            </div>
            <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                {% if recent_results %}
                    {% for result in recent_results %}
                        {% set status_class = 'success' if result.status_code and 200 <= result.status_code < 300 else 'error' %}
                        <div class="timeline-item {{ status_class }}">
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">{{ result.timestamp }}</small>
                                {% if result.status_code %}
                                    <span class="badge bg-{% if 200 <= result.status_code < 300 %}success{% elif 300 <= result.status_code < 400 %}warning{% else %}danger{% endif %} badge-sm">
                                        {{ result.status_code }}
                                    </span>
                                {% else %}
                                    <span class="badge bg-danger badge-sm">Error</span>
                                {% endif %}
                            </div>
                            <div class="fw-bold">{{ result.url }}</div>
                            <small class="text-muted">{{ result.group_name }}</small>
                            {% if result.response_time %}
                                <div><small class="text-info">{{ result.response_time }}ms</small></div>
                            {% endif %}
                            {% if result.error_message %}
                                <div class="text-danger">
                                    <small><i class="fas fa-exclamation-triangle"></i> {{ result.error_message }}</small>
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-clock fa-2x mb-2"></i>
                        <p>No recent activity</p>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Scheduler Info (Read-Only) -->
        <div class="card mt-3">
            <div class="card-header">
                <h6><i class="fas fa-info-circle"></i> System Status</h6>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <span>Monitoring:</span>
                    <span class="badge bg-{% if scheduler_status.status == 'running' %}success{% elif scheduler_status.status == 'paused' %}warning{% else %}danger{% endif %}">
                        {{ scheduler_status.status.title() }}
                    </span>
                </div>
                {% if scheduler_status.job_info and scheduler_status.job_info.next_run %}
                    <div class="d-flex justify-content-between align-items-center mt-2">
                        <span>Next Run:</span>
                        <small class="text-muted">{{ scheduler_status.job_info.next_run }}</small>
                    </div>
                {% endif %}
                <div class="mt-3 text-center">
                    <small class="text-muted">
                        <i class="fas fa-lock"></i> Read-Only Mode
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Refresh Button -->
<button class="btn btn-primary btn-lg refresh-button" onclick="location.reload();">
    <i class="fas fa-sync-alt"></i>
</button>
{% endblock %}

{% block scripts %}
<script>
    // Auto-refresh data every 30 seconds
    setInterval(function() {
        // Reload statistics
        fetch('/api/stats?filter={{ current_filter }}')
            .then(response => response.json())
            .then(data => {
                // Update stat cards (you could update these dynamically)
                console.log('Stats updated:', data);
            })
            .catch(error => console.error('Error updating stats:', error));
    }, 30000);
    
    // Add loading animation to refresh button
    document.querySelector('.refresh-button').addEventListener('click', function() {
        this.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i>';
    });
</script>
{% endblock %}
